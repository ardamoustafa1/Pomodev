<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Ge√ßmi≈üi - Pomodev</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .history-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover, .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }
        .stat-label {
            color: rgba(255,255,255,0.7);
            font-size: 0.9em;
            margin-top: 5px;
        }
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .history-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .history-date {
            font-weight: bold;
        }
        .history-mode {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            background: rgba(255,255,255,0.1);
        }
        .history-mode.pomodoro { background: rgba(255, 77, 79, 0.2); }
        .history-mode.short { background: rgba(77, 163, 255, 0.2); }
        .history-mode.long { background: rgba(167, 139, 250, 0.2); }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.5);
        }
        .search-box {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: var(--text);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="history-container">
        <div class="history-header">
            <h1>üìä Pomodoro Ge√ßmi≈üi</h1>
            <div>
                <a href="/" style="color: var(--primary); text-decoration: none;">‚Üê Ana Sayfaya D√∂n</a>
            </div>
        </div>

        <div class="history-stats" id="historyStats">
            <div class="stat-card">
                <div class="stat-value" id="totalSessions">0</div>
                <div class="stat-label">Toplam Seans</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalHours">0h</div>
                <div class="stat-label">Toplam S√ºre</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgPerDay">0</div>
                <div class="stat-label">G√ºnl√ºk Ortalama</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="longestStreak">0</div>
                <div class="stat-label">En Uzun Streak</div>
            </div>
        </div>

        <div class="filters">
            <input type="text" id="searchBox" class="search-box" placeholder="üîç Tarih veya mod ara...">
            <button class="filter-btn active" data-filter="all">T√ºm√º</button>
            <button class="filter-btn" data-filter="pomodoro">Pomodoro</button>
            <button class="filter-btn" data-filter="short">Kƒ±sa Mola</button>
            <button class="filter-btn" data-filter="long">Uzun Mola</button>
            <button class="filter-btn" onclick="exportSessionsToCSV()">üì• CSV Dƒ±≈üa Aktar</button>
        </div>

        <div class="history-list" id="historyList">
            <div class="empty-state">Y√ºkleniyor...</div>
        </div>
    </div>

    <script src="/static/script.js"></script>
    <script src="/static/export.js"></script>
    <script>
        let allHistory = [];
        let filteredHistory = [];

        // Load history
        function loadHistory() {
            const stats = JSON.parse(localStorage.getItem('pomodevData') || '{}');
            allHistory = stats.pomodoroHistory || [];
            filteredHistory = [...allHistory];
            
            updateStats();
            renderHistory();
        }

        // Update statistics
        function updateStats() {
            const totalSessions = allHistory.length;
            const totalMinutes = allHistory.reduce((sum, s) => sum + (s.duration || 25), 0);
            const totalHours = Math.floor(totalMinutes / 60);
            
            // Calculate average per day
            const dates = new Set(allHistory.map(s => new Date(s.timestamp).toDateString()));
            const avgPerDay = dates.size > 0 ? (totalSessions / dates.size).toFixed(1) : 0;
            
            // Calculate longest streak
            const sortedDates = Array.from(dates).sort();
            let longestStreak = 0;
            let currentStreak = 0;
            let lastDate = null;
            
            sortedDates.forEach(dateStr => {
                const date = new Date(dateStr);
                if (!lastDate) {
                    currentStreak = 1;
                } else {
                    const diffDays = Math.floor((date - lastDate) / (1000 * 60 * 60 * 24));
                    if (diffDays === 1) {
                        currentStreak++;
                    } else {
                        longestStreak = Math.max(longestStreak, currentStreak);
                        currentStreak = 1;
                    }
                }
                lastDate = date;
            });
            longestStreak = Math.max(longestStreak, currentStreak);

            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('totalHours').textContent = totalHours + 'h';
            document.getElementById('avgPerDay').textContent = avgPerDay;
            document.getElementById('longestStreak').textContent = longestStreak;
        }

        // Render history
        function renderHistory() {
            const list = document.getElementById('historyList');
            
            if (filteredHistory.length === 0) {
                list.innerHTML = '<div class="empty-state">Hen√ºz pomodoro ge√ßmi≈üi yok. ƒ∞lk pomodoronu tamamladƒ±ƒüƒ±nda burada g√∂r√ºnecek!</div>';
                return;
            }

            // Group by date
            const grouped = {};
            filteredHistory.forEach(session => {
                const date = new Date(session.timestamp).toLocaleDateString('tr-TR');
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(session);
            });

            // Sort dates (newest first)
            const sortedDates = Object.keys(grouped).sort((a, b) => {
                return new Date(b.split('.').reverse().join('-')) - new Date(a.split('.').reverse().join('-'));
            });

            list.innerHTML = sortedDates.map(date => {
                const sessions = grouped[date];
                const total = sessions.length;
                const totalMinutes = sessions.reduce((sum, s) => sum + (s.duration || 25), 0);
                
                return `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; color: var(--primary);">${date} (${total} seans, ${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m)</h3>
                        <div class="history-list">
                            ${sessions.map(s => {
                                const time = new Date(s.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                const mode = s.mode || 'pomodoro';
                                const duration = s.duration || 25;
                                return `
                                    <div class="history-item">
                                        <div>
                                            <div class="history-date">${time}</div>
                                            <div style="font-size: 0.85em; color: rgba(255,255,255,0.6); margin-top: 4px;">
                                                ${duration} dakika
                                            </div>
                                        </div>
                                        <span class="history-mode ${mode}">${mode === 'pomodoro' ? '‚è± Pomodoro' : mode === 'short' ? '‚òï Kƒ±sa Mola' : 'üå¥ Uzun Mola'}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter functionality
        document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const filter = btn.dataset.filter;
                if (filter === 'all') {
                    filteredHistory = [...allHistory];
                } else {
                    filteredHistory = allHistory.filter(s => s.mode === filter);
                }
                
                // Apply search filter
                applySearch();
            });
        });

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', (e) => {
            applySearch();
        });

        function applySearch() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            let filtered = filteredHistory;
            
            if (searchTerm) {
                filtered = filtered.filter(s => {
                    const date = new Date(s.timestamp).toLocaleDateString('tr-TR').toLowerCase();
                    const mode = (s.mode || '').toLowerCase();
                    return date.includes(searchTerm) || mode.includes(searchTerm);
                });
            }
            
            const originalFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
            if (originalFilter !== 'all') {
                filtered = filtered.filter(s => s.mode === originalFilter);
            }
            
            // Temporarily override filteredHistory for rendering
            const temp = filteredHistory;
            filteredHistory = filtered;
            renderHistory();
            filteredHistory = temp;
        }

        // Load on page load
        document.addEventListener('DOMContentLoaded', loadHistory);
    </script>
</body>
</html>
